{% extends "application/0_index.html" %}
{% load widget_tweaks %}
{% block title %}Текущие Обращения{% endblock %}
{% block header_link %}
{% load static %}
{% load poll_extras %}

<script src="//cdnjs.cloudflare.com/ajax/libs/jasny-bootstrap/3.1.3/js/jasny-bootstrap.min.js"></script>
<script type="text/javascript" src="{% static 'javascript/moments/moments.min.js' %}"></script>
<script type="text/javascript" src="{% static 'javascript/daterangepicker/daterangepicker.min.js' %}"></script>
<link rel="stylesheet" type="text/css" href="{% static 'javascript/daterangepicker/daterangepicker.css' %}" />
{# Maps is here   #}
<script src="https://polyfill.io/v3/polyfill.min.js?features=default"></script>
<link rel="stylesheet" type="text/css" href="{% static 'map/style.css' %}" />
<script src="{% static 'map/index.js' %}"></script>
<link href="{% static 'javacript/select2/select2.min.css' %}" rel="stylesheet" />
<script src="{% static 'javacript/select2/select2.min.js' %}"></script>
<link href="{% static 'map/2gis.css' %}" rel="stylesheet" />
{%endblock%}
{% block style %}
    <style>

        td {
            width: 50%;
        }
        .modal {
            z-index: 20;
        }
        .modal-backdrop {
            z-index: 10;
        }
        .select2 {
            width:100%!important;
        }
        .select2-selection__rendered {
            line-height: 31px !important;
        }
        .select2-container .select2-selection--single {
            height: 35px !important;
        }
        .select2-selection__arrow {
            height: 34px !important;
        }
        .select2-results__option--selected {
          background: #6c757d;
        }
        .fake_button{
            display: inline-block;
            background: #007bff;
            border-radius: 4px;
            color: #FFF;
            padding: 8px 12px;
            cursor: pointer;

        }
        .appeal_list {
          padding: 15px 0;
          border: solid 1px #555;
          box-shadow:  3px 3px  5px  rgba(0,0,0,0.6);
          -moz-box-shadow:  3px 3px  5px  rgba(0,0,0,0.6);
          -webkit-box-shadow:  3px 3px  5px  rgba(0,0,0,0.6);
          -o-box-shadow:  3px 3px 5px  rgba(0,0,0,0.6);
          border-radius: 8px;
        }
        .appeal_list:hover {
          cursor: pointer;
          background-color: #c7c6c3;
          box-shadow:  0 0 10px  rgba(0,0,0,0.6);
          -moz-box-shadow:  0 0 10px  rgba(0,0,0,0.6);
          -webkit-box-shadow:  0 0 10px  rgba(0,0,0,0.6);
          -o-box-shadow:  0 0 10px  rgba(0,0,0,0.6);
        }
        .appeal_content {
            padding: 5px;
            color: #52bfe3;
            font-weight: bold;
        }

    .modal {
        overflow: auto;
    }

    .scroll-hidden {
        overflow-y: hidden;
    }

    #new_income_button_modal,
    .btn-filter-form {
        text-transform: uppercase;
    }

    .form-group {
        margin-bottom: 1rem;
    }

    .form-row-flex {
        display: flex;
        column-gap: 1rem;
    }

    .form-row-flex col {
        flex: 1;
    }

    .modal-row {
        display: flex;
    }

    .audio-row-group {
        display: flex;
        flex: 1;
    }

    .audio-row-group audio {
        flex: 1;
    }

    .modal-footer {
        display: flex;
        justify-content: space-between;
    }

    #new_income_button_modal {
        width: fit-content;
    }

    .audio-row-group {
        column-gap: 1rem;
    }

    .form-error-field {
        height: min-content;
    }

    input::-webkit-outer-spin-button,
    input::-webkit-inner-spin-button {
        -webkit-appearance: none;
        margin: 0;
    }

    @media screen and (max-width: 1600px) {
        .date-start-field,
        .date-end-field {
            width: 100%;
        }

        .form-row-flex .col:first-child {
            margin-bottom: 1rem;
        }

        .form-row-flex {
            height: max-content;
            flex-direction: column;
        }
    }

    </style>

{% endblock %}
{% block content %}



<div class="row">

    <div class="table-container col-9">
        <div class="new-income-btn">
            <div class="d-grid gap-2" style="margin-bottom:24px;">
                 {% if user.userinfo.operator == True %}
                    <!-- Button trigger modal -->
                    <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#NewCallModal" id="new_income_button_modal">
                      <i class="fas fa-plus"></i> Новое обращение
                    </button>
                {% endif %}
              </div>
        </div>
{% if cur_appeal %}

{#    HIDDEN FORM FOR OPENING MODAL#}
    <form method="post" id="appeal_form">
    {% csrf_token %}
    <input type="hidden" name="appeal_input_id" id="appeal_input_id">
    </form>



{% for appeal in cur_appeal %}
  <div class="row appeal_list" style="margin: 0 0 5px 0;" id="appeal_{{ appeal.id }}">
      <div class="row">
          <div class="col-4">
              <span class="appeal_content">Дата вызова: </span>{{ appeal.date_of_call_start|date:"d M Y, H:i:s" }}<br>
              <span class="appeal_content">Город: </span>{% if appeal.city %}{{ appeal.city.name }}{% else %}НЕ УКАЗАН{% endif %}
          </div>
          <div class="col-4">
              <span class="appeal_content">Вопрос: </span>{{ appeal.question_category.name }}<br>
              <span class="appeal_content">Подразделение: </span>{{ appeal.get_responsible_department_display }}
          </div>
          <div class="col-3">
              <span class="appeal_content">Статус: </span>{% if appeal.status %}рассмотрен{% else %}на рассмотрении{% endif %}
          </div>
          <div class="col-1 text-center">
              {% if appeal.status %}
                  <i class="fas fa-circle fa-2x" style="color:greenyellow; margin-top: 7px;"></i>
              {% else %}

                  {% if appeal.date_of_call_start|time_passed%}
                  <div class="spinner-grow text-danger" role="status" style="margin-top: 7px;">
                      <span class="visually-hidden">Loading...</span>
                  </div>
                  {% else %}
                  <div class="spinner-grow text-warning" role="status" style="margin-top: 7px;">
                      <span class="visually-hidden">Loading...</span>
                  </div>
                  {% endif %}
              {% endif %}
          </div>
      </div>
  </div>
{% endfor %}
<div class="pagination">
    <span class="step-links">
        {% if cur_appeal.has_previous %}
            <a href="..{{ request.get_full_path | filter_pagination:1}}">&laquo; Начало</a>
            <a href="..{{ request.get_full_path | filter_pagination:cur_appeal.previous_page_number}}">Пред.</a>
        {% endif %}

        <span class="current">
            Стр {{ cur_appeal.number }} из {{ cur_appeal.paginator.num_pages }}.
        </span>

        {% if cur_appeal.has_next %}
            <a href="..{{ request.get_full_path | filter_pagination:cur_appeal.next_page_number }}">След.</a>
            <a href="..{{ request.get_full_path | filter_pagination:cur_appeal.paginator.num_pages }}">Посл. &raquo;</a>
        {% endif %}
    </span>
</div>

{% else %}
<h2>Пусто</h2>
{% endif %}
{% if user.userinfo.operator == True %}
    <!-- Modal -->
    {% include 'application/new_appeal.html' %}
{% endif %}
{% if cur_appeal_modal %}
<!-- Modal -->
{% include 'application/exist_appeal.html' %}
<!-- Modal -->
<div class="modal fade" id="answer_to_short_question_modal" tabindex="-1" aria-labelledby="answer_to_short_question_modal_label" aria-hidden="true"
data-bs-backdrop="static" data-bs-keyboard="false">
  <div class="modal-dialog modal-xl modal-dialog-centered modal-dialog-scrollable">
    <div class="modal-content" style="background: #ced4da;">
      <div class="modal-header">
        <h5 class="modal-title" id="answer_to_short_question_modal_label">Информация по учетной карточке</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
            <textarea class="form-control" id="answer_to_short_question_modal_value" rows="10"
                      name="answer_to_short_question_modal_value">{% if cur_appeal_modal.answer_to_short_question %}{{ cur_appeal_modal.answer_to_short_question }}{% endif %}</textarea>
      </div>
      <div class="modal-footer">
            <label for="employee-token-num" >Номер жетона сотрудника
                <input id="employee-token-num">
            </label>


        <div class="modal-footer-btns">
            {% if user.userinfo.operator == False %}
            <button type="button" class="btn btn-primary" id="save_answer_to_short_question" data-bs-dismiss="modal">Сохранить</button>
            {% endif %}
             <button type="button" class="btn btn-warning" data-bs-dismiss="modal">Закрыть</button>
        </div>

      </div>
    </div>
  </div>
</div>
{% endif %}


    </div>

    <div class="col-3">

<form method="get" class="filter-form" id="filter-form">

      <div class="row" style="margin-bottom:15px;">
        {% for hidden in cur_appeal_filter.form.hidden_fields %}
              {{ hidden }}
        {% endfor %}
        <div class="form-group form-row-flex">

            <div class="col date-start-field">
                {{ cur_appeal_filter.form.date.label_tag }}
                {% render_field cur_appeal_filter.form.date class="form-control date_class" %}
            </div>
            <div class="col date-end-field align-self-end">

            </div>
        </div>
      <div class="form-group form-error-field">
          {% for error in cur_appeal_filter.form.date.errors %}
            <p class="help-block">{{ error }}</p>
          {% endfor %}
      </div>

        <div class="form-group form-row-flex">
            <div class="col">
                {{ cur_appeal_filter.form.status.label_tag }}
                {% render_field cur_appeal_filter.form.status class="form-select" %}
            </div>
            <div class="col">
                <label for="income_call_number_display">Номер тел. клиента</label>
                <input type="text" class="form-control" id="income_call_number_display" data-mask="+9 (999) 999-9999">
            </div>
              <div class="col" style="display: none;">
                  {{ cur_appeal_filter.form.income_call_number.label_tag }}
                {% render_field cur_appeal_filter.form.income_call_number class="form-select filter-form-phone" %}
              </div>

        </div>
        <div class="form-group row-cols-2">
            {{ cur_appeal_filter.form.question_category.label_tag }}
            {% render_field cur_appeal_filter.form.question_category class="form-select" %}

        </div>
        <div class="gap-2 row-cols-1" style="margin-top:24px;">
              <button class="btn btn-primary btn-filter-form" id="search_filter" type="submit"><i class="fas fa-search"></i> Поиск</button>
        </div>
        <div class="gap-2 row-cols-1" style="margin-top:24px;">
              <button class="btn btn-primary btn-filter-form" type="button" onclick="download_report();"><i class="fas fa-file-download"></i> Скачать отчет</button>
             <a href="{{ request.get_full_path | filter_create_report }}" style="display: none" id="report_download"></a>
        </div>

    </div>


  </form>


</div>

</div>

{% endblock %}

{% block js %}

<script>

var mapOptions = {
        zoom: 16,
        center: new google.maps.LatLng(43.2567, 76.9286)
    };

    var map = new google.maps.Map(document.getElementById('map'), mapOptions);


//maps
markers = [];

function initialize() {
    var input = document.getElementById('address_modal'); 
    var autocomplete = new google.maps.places.Autocomplete(input);
    
    google.maps.event.addListener(autocomplete, 'place_changed', function () {
                for (var i = 0; i < markers.length; i++) {
                    markers[i].setMap(null);
                }
                var place = autocomplete.getPlace();
                //map.center = place.geometry.location;
                map.setCenter({
		            lat : place.geometry.location.lat(),
		            lng : place.geometry.location.lng()
	            });

                var marker = new google.maps.Marker({
                    position: place.geometry.location,
                    map: map
                });
                markers.push(marker);
                console.log(markers);
                map.panTo(place.geometry.location);

 
            });
}

google.maps.event.addDomListener(window, 'load', initialize);


    
const host_name = window.location.hostname;
{#console.log();#}
let socketAddress = 'ws://'+ host_name +'/ws/income_call/{{ user.id }}/'
let socket;
{#console.log({{ user.id }});#}
function download_report() {
    document.getElementById('report_download').click();
}

$(document).ready(function() {

    const urlSearchParams = new URLSearchParams(window.location.search);
    const params = Object.fromEntries(urlSearchParams.entries());
    console.log(params);


    const dateStartGenerated = document.getElementById('id_date_0');
    const dateEndGenerated = document.getElementById('id_date_1');
    const dateStartLabel = document.querySelector('[for="id_date_0"]');

const dateStartField = document.querySelector('.date-start-field');
const dateEndField = document.querySelector('.date-end-field');

dateEndField.innerHTML = " ";
dateEndField.appendChild(dateEndGenerated);
dateStartField.innerHTML = "";
dateStartField.appendChild(dateStartLabel);
dateStartField.appendChild(dateStartGenerated);





/*document.querySelector('.filter-form').addEventListener('submit', function (event) {
    event.preventDefault();


    document.getElementById('id_date_0').value = moment($('#id_date_0').datepicker("getDate")).format('YYYY-MM-DD HH:mm');
        document.getElementById('id_date_1').value = moment($('#id_date_1').datepicker("getDate")).format('YYYY-MM-DD HH:mm');
});*/



$(function() {
  $('#id_date_0').daterangepicker({
      timePicker: true,
      timePicker24Hour: true,
      timePickerIncrement: 30,
      singleDatePicker: true,
      showDropdowns: true,
      minYear: 2020,
      maxYear: parseInt(moment().format('YYYY'), 10),

      maxDate: moment().format('YYYY-MM-DD 23:30:00'),
      startDate: moment().subtract(1,'days').startOf('hour'),
      locale: {
        format: 'YYYY-MM-DD HH:mm',
        "applyLabel": "Ввод",
        "cancelLabel": "Отмена",
        "fromLabel": "От",
        "toLabel": "До",
        "daysOfWeek": [
             "Вс",
             "Пн",
             "Вт",
             "Ср",
             "Чт",
             "Пт",
             "Сб"
         ],
         "monthNames": [
             "Январь",
             "Февраль",
             "Март",
             "Апрель",
             "Май",
             "Июнь",
             "Июль",
             "Август",
             "Cентябрь",
             "Октябрь",
             "Ноябрь",
             "Декабрь"
         ],
        "firstDay": 1

      }
  });
  $('#id_date_1').daterangepicker({
    timePicker: true,
    timePicker24Hour: true,
      timePickerIncrement: 30,
    singleDatePicker: true,
      showDropdowns: true,
      minYear: 2020,
      maxYear: parseInt(moment().format('YYYY'), 10),

      maxDate: moment().format('YYYY-MM-DD 23:30:00'),
    startDate: moment().add(1,'minutes'),
    locale: {
      format: 'YYYY-MM-DD HH:mm',

      {#    {#}
      {#    toDisplay: function () {#}
      {#      return 'YYYY-MM-DD HH:mm';#}
      {#    },#}
      {#    toValue: function() {#}
      {#        return 'YYYY-MM-DD HH:mm';#}
      {#    },#}
      "applyLabel": "Ввод",
      "cancelLabel": "Отмена",
      "fromLabel": "От",
      "toLabel": "До",
      "daysOfWeek": [
            "Вс",
            "Пн",
            "Вт",
            "Ср",
            "Чт",
            "Пт",
            "Сб"
        ],
        "monthNames": [
            "Январь",
            "Февраль",
            "Март",
            "Апрель",
            "Май",
            "Июнь",
            "Июль",
            "Август",
            "Cентябрь",
            "Октябрь",
            "Ноябрь",
            "Декабрь"
        ],
      "firstDay": 1

    }
});
});


const outterContainer = document.querySelector('.main-page-container');

function addBtnListeners() {
    const modalCloseBtns = document.querySelectorAll('.modal-close-btn');

    for(let i = 0; i < modalCloseBtns.length; i++) {
        modalCloseBtns[i].addEventListener('click', () => {
            outterContainer.classList.remove('scroll-hidden');
        });
    }
}

{% if cur_appeal_modal %}
    $('#ExistedCallModal').modal('show');
    outterContainer.classList.add('scroll-hidden');
    addBtnListeners();


    // /* Format phone number field */

    // {% if cur_appeal_modal.income_call_number %}
    //     let incomePhoneNumber = {{ cur_appeal_modal.income_call_number }};
    //     incomePhoneNumber = incomePhoneNumber.toString();
    //     if(incomePhoneNumber.startsWith('8')) {
    //         document.getElementById('income_call_number_modal').value = incomePhoneNumber[0] + ' (' + incomePhoneNumber.substr(1, 3) + ') '
    //             + incomePhoneNumber.substr(4, 3) + '-' + incomePhoneNumber.substr(7);
    //     }
    //     else {
    //         document.getElementById('income_call_number_modal').value = '+' + incomePhoneNumber[0] + ' (' + incomePhoneNumber.substr(1, 3) + ') '
    //             + incomePhoneNumber.substr(4, 3) + '-' + incomePhoneNumber.substr(7);
    //     }
    // {% endif %}

    // {%if cur_appeal_modal.callback_number %}
    //     let callbackPhoneNumber = {{ cur_appeal_modal.callback_number }};
    //     callbackPhoneNumber = callbackPhoneNumber.toString();
    //     if(callbackPhoneNumber.startsWith('8')) {
    //         document.getElementById('callback_number_modal').value = callbackPhoneNumber[0] + ' (' + callbackPhoneNumber.substr(1, 3) + ') '
    //             + callbackPhoneNumber.substr(4, 3) + '-' + callbackPhoneNumber.substr(7);
    //     }
    //     else {
    //         document.getElementById('callback_number_modal').value = '+' + callbackPhoneNumber[0] + ' (' + callbackPhoneNumber.substr(1, 3) + ') '
    //             + callbackPhoneNumber.substr(4, 3) + '-' + callbackPhoneNumber.substr(7);
    //     }

    // {%endif%}

{% endif %}
 //CLICK DIV APPEAL TO OPEN MODAL
$("div[id^=appeal_]").click(function (){
    $('#appeal_input_id').val(this.id);
    $('#appeal_form').submit();
});
$.fn.modal.Constructor.prototype._enforceFocus = function() {};
$('.select2_selection').select2({
    placeholder:  'Выберите',
    theme: "classic"
});
$('#emergency_rank').select2({
    minimumResultsForSearch: Infinity
});
$('.select2_selection').val('').trigger('change');


{% if user.userinfo.operator == True %}



// SEND APPEAR/PROBLEM TO DEPARTMENT
$('#send_to_department_problem').click(function (){
    $('#status').val('False');
});

$('#new_income_button_modal').click(function (){
    let date = new Date().toLocaleString('ru-RU');
    let currentDate = date.substring(0,10);
    let currentTime = date.substring(12,20);
    document.getElementById('time_of_call_end').value = '';
    document.getElementById('time_of_call').value = currentTime;
    document.getElementById('date_of_call').value = currentDate;
});

function ws_connection() {
    socket = new WebSocket(socketAddress);

    socket.onopen = function () {
        console.log('Connected to websocket open');
    }

    socket.onmessage = function (event) {
        let income_call = JSON.parse(event.data);
        console.log(income_call);
        if (income_call['api']===1){
            let newIncomeNumber = income_call['number_in'];
            newIncomeNumber = newIncomeNumber.toString();
            let callFieldValue;
            if(newIncomeNumber.startsWith('8')) {
                 callFieldValue = newIncomeNumber[0] +
                    ' (' + newIncomeNumber.substr(1, 3) + ') ' + newIncomeNumber.substr(4, 3) + '-' + newIncomeNumber.substr(7);
            }
            else {
                callFieldValue = '+' + newIncomeNumber[0] +
                    ' (' + newIncomeNumber.substr(1, 3) + ') ' + newIncomeNumber.substr(4, 3) + '-' + newIncomeNumber.substr(7);
            }
            //console.log(income_call['number_in'], income_call['unique_id'], income_call['data_for_number_in']);
            $('#current_emergency_form').on("submit", function (e) {
                e.preventDefault();
                let formModal = $(this);
                $('#income_call_number').val(income_call['number_in']);
                let callbackNumber = document.getElementById('callback_number').value;
                if (callbackNumber != '') {
                    document.getElementById('callback_number').value = callbackNumber[1] +
                        callbackNumber.substr(4, 3) + callbackNumber.substr(9, 3) + callbackNumber.substr(13);
                }
                $('#current_emergency_form').off("submit");
                formModal.submit();
            });
            // Start modal
            if ($('#NewCallModal').is(':visible')) {
                document.querySelector('#income_call_number').value = callFieldValue;
                document.querySelector('input[name="new_income_when_model_open"]').value = callFieldValue;
                //$("input[name='new_income_when_model_open']").val(income_call['number_in']);

                $('#current_emergency_form').submit();

            };
            $('#NewCallModal').modal('show');
            // Income call number
            document.querySelector('#income_call_number').value = callFieldValue;
            //$('#income_call_number').val(income_call['number_in']);
            $('#income_call_number').attr('readonly', true);
            $('#api_unique_id').val(income_call['unique_id']);

            if (income_call['data_for_number_in']) {
                $('#income_call_name').val(income_call['data_for_number_in']['income_call_name']);
                $('#iin').val(income_call['data_for_number_in']['iin']);
                $('#short_question').val(income_call['data_for_number_in']['short_question']);
                $('#count_call_new_appeal').val(income_call['count_call_new_appeal']);
                document.getElementById('div_count_call_new_appeal').style.display = 'block';
            } else {
                document.getElementById('div_count_call_new_appeal').style.display = 'none';
                $('#income_call_name').val('');
                $('#iin').val('');
                $('#short_question').val('');
                $('#count_call_new_appeal').val('');
            }

            let date = new Date().toLocaleString('ru-RU');
            let currentDate = date.substring(0,10);
            let currentTime = date.substring(12,20);
            document.getElementById('time_of_call_end').value = '';
            document.getElementById('time_of_call').value = currentTime;
            document.getElementById('date_of_call').value = currentDate;

        } else if (income_call['api']===2){

            console.log('here we are api 2')
            //console.log(income_call['unique_id'])
            let date = new Date().toLocaleString('ru-RU');
            //let currentDate = date.substring(0,10);
            let currentTime = date.substring(12,20);
            document.getElementById('time_of_call_end').value = '';
            document.getElementById('time_of_call_end').value = currentTime;
            //document.getElementById('time_of_call_end').value = income_call['end_time'];
        }
    };

    socket.onclose = function (event) {
        console.log('Connection interrupted', event);
        setTimeout(function() {
          ws_connection();
        }, 1000);
    };

    socket.onerror = function(err) {
        console.error('Socket encountered error: ', err.message, 'Closing socket');
        ws.close();
    };
}

ws_connection();

{% else %}
// USER IS NOT OPERATOR DEPARTMENT PERSON

    $('#save_answer_to_short_question').click(function (){
            let modal_var = $('#answer_to_short_question_modal_value').val();
            //console.log(modal_var);
            $('#answer_to_short_question').val(modal_var);
    });

{% endif %}

const btn_show_all_call = document.getElementById('show_all_call_number');
if (btn_show_all_call) {
    function search_calls_number() {
        let incomeCallNumber = document.getElementById('income_call_number_modal').value;
        if(incomeCallNumber.startsWith('8')) {
            document.getElementById('id_income_call_number').value = incomeCallNumber[0] +
                        incomeCallNumber.substr(3, 3) + incomeCallNumber.substr(8, 3) + incomeCallNumber.substr(12);
        }
        else {
            document.getElementById('id_income_call_number').value = incomeCallNumber[1] +
                        incomeCallNumber.substr(4, 3) + incomeCallNumber.substr(9, 3) + incomeCallNumber.substr(13);
        }
        document.getElementById('id_date_0').value = '';
        document.getElementById('id_date_1').value = '';
        document.getElementById('search_filter').click();
    }
    btn_show_all_call.addEventListener("click", search_calls_number);
}

const btn_show_all_call_new_appeal = document.getElementById('show_all_call_number_new_appeal');
if (btn_show_all_call_new_appeal) {
    function search_calls_number_new_appeal() {
        let incomeCallNumber = document.getElementById('income_call_number').value;
        if(incomeCallNumber.startsWith('8')) {
            document.getElementById('id_income_call_number').value = incomeCallNumber[0] +
                        incomeCallNumber.substr(3, 3) + incomeCallNumber.substr(8, 3) + incomeCallNumber.substr(12);
        }
        else {
            document.getElementById('id_income_call_number').value = incomeCallNumber[1] +
                        incomeCallNumber.substr(4, 3) + incomeCallNumber.substr(9, 3) + incomeCallNumber.substr(13);
        }
        document.getElementById('id_date_0').value = '';
        document.getElementById('id_date_1').value = '';
        document.getElementById('search_filter').click();
    }
    btn_show_all_call_new_appeal.addEventListener("click", search_calls_number_new_appeal);
}

if(params.income_call_number != '' && typeof(params.income_call_number) != 'undefined') {
    let filterFormPhone = params.income_call_number;
    if(filterFormPhone.startsWith('8')) {
        document.querySelector('#income_call_number_display').value = filterFormPhone[0] + ' (' + filterFormPhone.substr(1, 3) + ') ' +
            filterFormPhone.substr(4, 3) + '-' + filterFormPhone.substr(7);
    }
    else {
        document.querySelector('#income_call_number_display').value = '+' + filterFormPhone[0] + ' (' + filterFormPhone.substr(1, 3) + ') ' +
            filterFormPhone.substr(4, 3) + '-' + filterFormPhone.substr(7);
    }
}

document.querySelector('#search_filter').addEventListener('click', function () {
    document.getElementById('id_income_call_number').value = '';
});

$('#filter-form').on("submit", function (e) {
    e.preventDefault();
    let filterForm = $(this);
    let phoneStr = document.getElementById('income_call_number_display').value;
    let phoneStrHidden = document.getElementById('id_income_call_number').value;
    //console.log('phonestr', phoneStr);
    if(phoneStr == '' && phoneStrHidden == '') {
        document.querySelector('.filter-form-phone').value = '';
    }
    else if(phoneStr != '' && phoneStrHidden == '') {
        if(phoneStr.startsWith('8')) {
            document.querySelector('.filter-form-phone').value = phoneStr[0] +
                        phoneStr.substr(3, 3) + phoneStr.substr(8, 3) + phoneStr.substr(12);
        }
        else {
            document.querySelector('.filter-form-phone').value = phoneStr[1] +
                        phoneStr.substr(4, 3) + phoneStr.substr(9, 3) + phoneStr.substr(13);
        }
    }

    $('#filter-form').off("submit");
    filterForm.submit();

});


})

//filter-form-phone

</script>

{% endblock %}
